# 为什么要多写集成测试

## 前言

哈喽，大家好，我是海怪。

相信有不少人是了解测试的分类的：单测 > 集成 > E2E，他们的比例就像金字塔一样。但是真实情况可能并不是我们想的那么理想，很多时候集成测试反而会比单测更有作用。

Kent 在 [《Write tests. Not too many. Mostly integration.》](https://kentcdodds.com/blog/write-tests) 这篇文章里也说了这个观点。今天就来给大家分享一下他的想法吧。

---

## 正片开始


很久之前，[Guillermo Rauch‏](https://twitter.com/rauchg)（[Socket.io](https://socket.io/) 的作者）就发了一条让人印象深刻的 Tweet：

![](https://files.mdnice.com/user/24913/b84658a8-d820-4abe-b71b-ce43a8656554.png)

> 写测试，别太多，大部分集成测试就好了

虽然很短，但是很有深度，现在让我们一起来研究一下吧。

## 写测试

是的，对大多数项目来说，你都应该写测试。如果你是个珍惜时间的人，那么更应该写。在写测试中找 Bug 好过你在凌晨 2 点的时候被叫起来修 Bug。 **我发现越花时间在写测试，越是能帮我省不少时间。** 虽然实现起来不知道会用更多时间，还是更少时间，但是肯定的是我在维护的时候是不用太费时间的。

写测试时，你应该考虑的事情是它们给你带来了多少信心，即你的项目没有错误。像 TypeScript 和 ESLint 这些静态代码检查工具也能带来很强的自信的，如果你还没有用上它们，强烈建议你试一下。不过，**即使是强类型语言也是需要测试的**。类型检查和风格检查不能完全保障你的业务代码是没 Bug 的。因此你需要好的测试用例来给你带来更强的信心。

## 别写太多

我经常听到一些项目里的 Leader 和 Manager 会强制要求 100% 的覆盖率，这其实是不对的。这里的问题点是：**随着覆盖率增加到 70% 以上，测试收益会逐渐减少**。（70% 是我瞎编的）。为什么这么说呢？因为当你为了那 100% 的覆盖率而不断努力时，你会发现要花费大量时间在那些根本不需要测试的事情上。这些东西里面可能根本没啥逻辑（这些 Bug 其实是可以被 ESLint 检查出来的）。如果要维护这些测试用例会严重地拖垮你团队的开发进度。

你会慢慢发现自己一直在测一些代码实现细节，来确保能测到测试环境中难以复现的那一行代码。实际上，你应该避免测试代码细节，因为它不会给你带来太多关于 “应用是否正确运行” 的信心，而且还会拖慢你重构时的速度。**当在做代码重构时，你不应该频繁地修改测试用例才对**。

不过，我得提一下，几乎我所有的开源项目都是 100% 的测试覆盖的。这是因为它们大多数都是很小的库和工具，而且会在很多不同情况下被使用（一旦崩了，可能会导致使用方出很严重的问题）。同时，它们也很容易就能达到 100% 的覆盖率。

## 大多数时候写集成测试

目前有很多种不同类型的测试。它们都有自己的优势和劣势。其中，三个最常见的测试类型就是：单测测试、集成测试、和端对端测试。

![](https://files.mdnice.com/user/24913/6b8bdbb7-8d53-4a47-8829-527b1d10d26c.jpg)

这个测试金字塔是我结合了 [Martin Fowler 的博客](https://martinfowler.com/bliki/TestPyramid.html) 和 [Google 测试博客](https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html) 画出来的。

就像图里展示的那样，金字塔从下到上，分别是：单元测试、集成测试和端对端测试。越往上走，你的测试用例会跑得越慢，越难写，而且维护/执行成本越高（时间和资源成本）。由于成本问题，这意味着你应该把更多时间花在写单测上。

然而，有一件事它没有告诉你的是：**越往上走，不同各类的带给你的代码信心就会越高。** 你是会得到更多回报的。所以说，E2E 测试比单测可能更慢而且成本更高，但它会给你带来更多的代码信心。

要注意的是，我们的工具已经超越了 Martin 最初的测试金字塔概念中的假设。这就是为什么我创造了 "The Testing Trophy" 的概念 🏆。

![](https://files.mdnice.com/user/24913/42aa95b2-5184-4a31-a32e-56e01c495861.jpg)

集成测试的好处是：你可以不用纠结类似 *“组件 `<A/>` 用 `c` 和 `d` Props 来渲染 `<B/>`，然后 `<B/>` 因为没有传 `e` 这个 Props 而炸了”* 这的问题了。当然用单测来测这些零零散散的东西也不错啦，但是如果不能测试它们共同工作的结果，那其实意义并不大。而且你会发现如果能合理地测试它们共同工作的场景，那么你通常是不需要将它们隔离起来做测试的。

**集成测试在信心和速度/费用之间的权衡上取得了很好的平衡。** 这也是为什么更建议你花更多（也不是所有，看你自己）的时间来往这个方向努力。

## 如何写更多的集成测试

集成测试和单测的界限是有点模糊的。不过，我觉得能够写更多集成测试的关键是 **别 Mock 太多东西。** 因为当你把东西都做了 Mock 之后，你自然会失去要测试的东西以及被 Mock 了的东西的信心。我知道并不是所有情况都是这样的，比如你也肯定会对支付接口做 Mock 操作嘛。

## 总结

我认为没有人会争辩说测试软件是在浪费时间。测试最大的挑战是 [知道哪些要测](https://kentcdodds.com/blog/how-to-know-what-to-test) 以及如何通过做测试来获得更高的自信，而非通过一遍遍测细节来获得虚假的覆盖率。

---


**好了，这篇外文就给大家带到这里了。最近我也给项目写不少单测，其实单测和集成测试还是有很多互补的地方的。Jest 不仅仅是为了单测，集成测试也可以的。而且当你发现要测试的东西太复杂，太多干扰项时，使用集成测试会让你真正从用户的角度来写测试。这时，你不会关注那些覆盖率的指标了，而是从一个用户的角度来思考这样的用例能给我带来多少信心。**

**如果你喜欢我的分享，可以来一波一键三连，点赞、在看就是我最大的动力，比心 ❤️**
